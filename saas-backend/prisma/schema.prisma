generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ThemeMode {
  LIGHT
  DARK
}

enum OrderStatus {
  PLACED
  CONFIRMED
  PACKED
  SHIPPED
  DELIVERED
}

model Store {
  id              String      @id @default(cuid())
  name            String
  slug            String      @unique
  logo            String?
  primaryColor    String?
  secondaryColor  String?
  backgroundImage String?
  whatsappNumber  String
  currency        String      @default("INR")
  themeMode       ThemeMode   @default(DARK)

  admins          AdminUser[]
  customers       Customer[]
  categories      Category[]
  products        Product[]
  orders          Order[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([slug])
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  orders    Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, phone])
  @@index([storeId])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String?
  bannerImage String?
  parentId    String?
  sortOrder   Int      @default(0)
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryToCategory")
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  products  Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([parentId])
}

model Product {
  id          String    @id @default(cuid())
  name        String
  description String?
  price       Decimal
  images      String[]
  stock       Int       @default(0)

  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  orderItems  OrderItem[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([storeId])
  @@index([categoryId])
}

model Order {
  id           String      @id @default(cuid())
  customerId   String
  customer     Customer    @relation(fields: [customerId], references: [id], onDelete: Restrict)

  storeId      String
  store        Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)

  status       OrderStatus @default(PLACED)
  totalAmount  Decimal
  shippingInfo Json?

  items        OrderItem[]
  logs         OrderStatusLog[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([storeId])
  @@index([customerId])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  quantity  Int
  price     Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
}

model OrderStatusLog {
  id                String      @id @default(cuid())
  orderId           String
  order             Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  oldStatus         OrderStatus?
  newStatus         OrderStatus
  timestamp         DateTime    @default(now())

  whatsappTo        String?
  messageText       String?
  providerMessageId String?

  @@index([orderId])
  @@index([timestamp])
}

